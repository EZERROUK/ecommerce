openapi: 3.0.3
info:
  title: X-Zone / X-Panel API
  version: 1.0.0
  description: |
    API publique + portail client X-Zone Technologies.

    - Toutes les routes commencent par /api (ex: https://xpanel.test/api/products)
    - Les routes "client" protégées utilisent Laravel Sanctum (token d'accès personnel).

servers:
  - url: https://xpanel.test/api
    description: Environnement de développement (exemple)

tags:
  - name: Catalogue
    description: Produits & recherche
  - name: Catégories
    description: Arborescence et filtres de catégories
  - name: Client Auth
    description: Authentification portail client
  - name: Client Profil
    description: Profil client connecté
  - name: Client Quotes
    description: Devis du client
  - name: Client Invoices
    description: Factures du client
  - name: Client Orders
    description: Commandes du client
  - name: Client Tickets
    description: Tickets de support
  - name: Client Documents
    description: Documents produits accessibles au client
  - name: Client Configurator
    description: Enregistrement de configurations personnalisées
  - name: Backoffice
    description: API interne utilisée par le backoffice (Inertia)

components:
  securitySchemes:
    SanctumToken:
      type: http
      scheme: bearer
      bearerFormat: "Personal Access Token"

  schemas:
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Une erreur est survenue."
      required: [success, message]

    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "TechSolutions Admin"
        email:
          type: string
          format: email
          example: "client@entreprise.ma"
        portal_client:
          type: boolean
          example: true
        client_id:
          type: integer
          nullable: true
          example: 12
      required: [id, name, email, portal_client]

    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          example: "client@entreprise.ma"
        password:
          type: string
          format: password
          example: "secret"
      required: [email, password]

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        token:
          type: string
          description: "Token Sanctum à envoyer en Authorization: Bearer {token}"
          example: "1|T0k3nSanctum..."
        user:
          $ref: '#/components/schemas/User'
      required: [success, token, user]

    ProductDocument:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
          example: "Fiche technique complète"
        type:
          type: string
          example: "datasheet"
        file_url:
          type: string
          format: uri
          example: "https://xpanel.test/storage/docs/fiche-technique.pdf"
        product_id:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProductAttribute:
      type: object
      properties:
        name:
          type: string
          example: "RAM"
        value:
          type: string
          example: "32 Go"

    Product:
      type: object
      properties:
        id:
          type: integer
          example: 101
        sku:
          type: string
          example: "SRV-PE-X1"
        name:
          type: string
          example: "Serveur Pro Enterprise X1 (Dell PowerEdge)"
        slug:
          type: string
          example: "serveur-pro-enterprise-x1-dell-poweredge"
        price:
          type: number
          format: float
          example: 24990.0
        price_ht:
          type: number
          format: float
          example: 20825.0
        stock:
          type: integer
          example: 5
        description:
          type: string
          example: "Serveur rack robuste pour PME."
        images:
          type: array
          items:
            type: string
            format: uri
        category:
          $ref: '#/components/schemas/Category'
        documents:
          type: array
          items:
            $ref: '#/components/schemas/ProductDocument'
        attributes:
          type: array
          items:
            $ref: '#/components/schemas/ProductAttribute'

    Category:
      type: object
      properties:
        id:
          type: integer
          example: 10
        name:
          type: string
          example: "Serveurs"
        slug:
          type: string
          example: "serveurs"
        parent_id:
          type: integer
          nullable: true
        children:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    Quote:
      type: object
      properties:
        id:
          type: integer
        reference:
          type: string
          example: "DEV-2025-00123"
        status:
          type: string
          example: "pending"
        total_ht:
          type: number
          format: float
        total_ttc:
          type: number
          format: float
        created_at:
          type: string
          format: date-time

    Invoice:
      type: object
      properties:
        id:
          type: integer
        reference:
          type: string
          example: "FAC-2025-00045"
        status:
          type: string
          example: "unpaid"
        total_ht:
          type: number
          format: float
        total_ttc:
          type: number
          format: float
        due_date:
          type: string
          format: date
        created_at:
          type: string
          format: date-time

    Order:
      type: object
      properties:
        id:
          type: integer
        reference:
          type: string
          example: "CMD-2025-00012"
        status:
          type: string
          example: "processing"
        total_ht:
          type: number
          format: float
        total_ttc:
          type: number
          format: float
        created_at:
          type: string
          format: date-time

    TicketMessage:
      type: object
      properties:
        id:
          type: integer
        sender_type:
          type: string
          example: "client"
        sender_name:
          type: string
        message:
          type: string
        created_at:
          type: string
          format: date-time

    Ticket:
      type: object
      properties:
        id:
          type: integer
        subject:
          type: string
          example: "Problème de connexion à l'espace Pro"
        status:
          type: string
          example: "open"
        priority:
          type: string
          example: "normal"
        created_at:
          type: string
          format: date-time
        messages:
          type: array
          items:
            $ref: '#/components/schemas/TicketMessage'

    TicketCreateRequest:
      type: object
      properties:
        subject:
          type: string
        message:
          type: string
      required: [subject, message]

    TicketReplyRequest:
      type: object
      properties:
        message:
          type: string
      required: [message]

    ConfiguratorRequest:
      type: object
      properties:
        product_id:
          type: integer
          example: 101
        ram:
          type: string
          example: "64 Go"
        storage:
          type: string
          example: "2x 960GB SSD"
        raid:
          type: string
          example: "RAID 1"
        notes:
          type: string
          nullable: true
          example: "Usage pour virtualisation, merci de préciser la dispo."
      required: [product_id]

paths:
  # --------------------------------------------------
  # AUTH CLIENT
  # --------------------------------------------------
  /client/login:
    post:
      tags: [Client Auth]
      summary: Connexion au portail client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Identifiants invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /client/logout:
    post:
      tags: [Client Auth]
      summary: Déconnexion du portail client
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Déconnexion réussie.
        '401':
          description: Non authentifié.

  /user:
    get:
      tags: [Client Auth]
      summary: Retourne l'utilisateur courant (token)
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Utilisateur courant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Non authentifié

  # --------------------------------------------------
  # PROFIL CLIENT
  # --------------------------------------------------
  /client/me:
    get:
      tags: [Client Profil]
      summary: Détails du profil client connecté
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Profil client
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Non authentifié

  # --------------------------------------------------
  # QUOTES (DEVIS)
  # --------------------------------------------------
  /client/quotes:
    get:
      tags: [Client Quotes]
      summary: Liste des devis du client connecté
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Liste paginée ou simple des devis
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  quotes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quote'
        '401':
          description: Non authentifié

  /client/quotes/{id}:
    get:
      tags: [Client Quotes]
      summary: Détail d'un devis
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail du devis
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  quote:
                    $ref: '#/components/schemas/Quote'
        '404':
          description: Devis introuvable

  # --------------------------------------------------
  # INVOICES (FACTURES)
  # --------------------------------------------------
  /client/invoices:
    get:
      tags: [Client Invoices]
      summary: Liste des factures du client
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Liste des factures
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  invoices:
                    type: array
                    items:
                      $ref: '#/components/schemas/Invoice'

  /client/invoices/{id}:
    get:
      tags: [Client Invoices]
      summary: Détail d'une facture
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail de la facture
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  invoice:
                    $ref: '#/components/schemas/Invoice'
        '404':
          description: Facture introuvable

  # --------------------------------------------------
  # ORDERS (COMMANDES)
  # --------------------------------------------------
  /client/orders:
    get:
      tags: [Client Orders]
      summary: Liste des commandes du client
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Liste des commandes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'

  /client/orders/{id}:
    get:
      tags: [Client Orders]
      summary: Détail d'une commande
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail de la commande
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  order:
                    $ref: '#/components/schemas/Order'
        '404':
          description: Commande introuvable

  # --------------------------------------------------
  # SUPPORT TICKETS
  # --------------------------------------------------
  /client/tickets:
    get:
      tags: [Client Tickets]
      summary: Liste des tickets du client
      security:
        - SanctumToken: [ ]
      responses:
        '200':
          description: Liste des tickets
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tickets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'

    post:
      tags: [Client Tickets]
      summary: Créer un nouveau ticket de support
      security:
        - SanctumToken: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketCreateRequest'
      responses:
        '201':
          description: Ticket créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticket:
                    $ref: '#/components/schemas/Ticket'

  /client/tickets/{id}:
    get:
      tags: [Client Tickets]
      summary: Détail d'un ticket (avec messages)
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail du ticket
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '404':
          description: Ticket introuvable

  /client/tickets/{id}/reply:
    post:
      tags: [Client Tickets]
      summary: Répondre à un ticket existant
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketReplyRequest'
      responses:
        '201':
          description: Message ajouté
        '404':
          description: Ticket introuvable

  # --------------------------------------------------
  # DOCUMENTS PRODUITS
  # --------------------------------------------------
  /client/products/{id}/documents:
    get:
      tags: [Client Documents]
      summary: Liste des documents liés à un produit (version portail client)
      security:
        - SanctumToken: [ ]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Liste des documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  documents:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductDocument'

  /products/{id}/documents:
    get:
      tags: [Client Documents]
      summary: Liste des documents liés à un produit (accès public ou semi-public)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Liste des documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  documents:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductDocument'

  # --------------------------------------------------
  # CONFIGURATEUR VISUEL
  # --------------------------------------------------
  /client/configurator:
    post:
      tags: [Client Configurator]
      summary: Enregistrer une demande de configuration personnalisée
      security:
        - SanctumToken: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfiguratorRequest'
      responses:
        '201':
          description: Configuration enregistrée (souvent transformée en demande de devis)
        '400':
          description: Données invalides

  # --------------------------------------------------
  # CATALOGUE PUBLIC
  # --------------------------------------------------
  /products:
    get:
      tags: [Catalogue]
      summary: Liste des produits (paginée)
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 12
        - name: category_id
          in: query
          schema:
            type: integer
          description: Filtrer par catégorie
      responses:
        '200':
          description: Liste de produits
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  current_page:
                    type: integer
                  per_page:
                    type: integer
                  total:
                    type: integer

  /products/{id}:
    get:
      tags: [Catalogue]
      summary: Détail d'un produit
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Produit détaillé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          description: Produit introuvable

  /products/search:
    get:
      tags: [Catalogue]
      summary: Recherche avancée de produits
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: Mot-clé
        - name: category_id
          in: query
          schema:
            type: integer
        - name: min_price
          in: query
          schema:
            type: number
        - name: max_price
          in: query
          schema:
            type: number
        - name: sort
          in: query
          schema:
            type: string
            example: "price_asc"
      responses:
        '200':
          description: Résultats de recherche
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'

  # --------------------------------------------------
  # CATEGORIES PUBLIC
  # --------------------------------------------------
  /categories/tree:
    get:
      tags: [Catégories]
      summary: Arborescence complète des catégories
      responses:
        '200':
          description: Arborescence complète
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /categories/{id}/tree:
    get:
      tags: [Catégories]
      summary: Détail d'une catégorie + enfants
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Catégorie + sous-catégories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '404':
          description: Catégorie introuvable

  /categories/{id}/products:
    get:
      tags: [Catégories]
      summary: Produits d'une catégorie
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
        - name: per_page
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Produits de la catégorie
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'

  /categories/{id}/filters:
    get:
      tags: [Catégories]
      summary: Filtres dynamiques calculés pour une catégorie
      description: Prix min/max, marques, attributs disponibles…
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Filtres disponibles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  filters:
                    type: object
                    additionalProperties: true

  /categories/{category}/attributes:
    get:
      tags: [Backoffice]
      summary: Attributs d'une catégorie (usage back-office)
      parameters:
        - name: category
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Attributs de la catégorie
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductAttribute'
